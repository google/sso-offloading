<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Simple IWA</title>
    <script type="module" src="/main.ts"></script>
  </head>
<body>
    <div class="container sso">
        <div class="ssoBody" style="height: 1000px;">
            <h1>SSO Offloading</h1>
            <p>
                By default, the resulting OAuth flow would redirect to a Google
                account login page because the controlled frame's isolated context
                doesn't have any Google accounts logged in. After logging in, the
                OAuth request would continue.
            </p>
            <p>Submit the extension ID and auth URL to setup SSO offloading.</p>
            <form id="ssoForm">
                <label for="extensionId">Extension ID:</label><br />
                <input type="text" id="extensionId" class="ssoFormElement" name="extensionId"
                    value="jmdcfpeebneidlbnldlhcifibpkidhkn" /><br /><br />
                <label for="authUrl">Auth URL:</label><br />
                <input type="text" id="authUrl" class="ssoFormElement"
                    value="https://accounts.google.com/o/oauth2/v2/auth*" name="authUrl" /><br /><br />
                <input type="submit" id="ssoSubmitButton" class="ssoFormElement" value="Submit" />
            </form>
            <p>When SSO offloading is set up, we do the following:</p>
            <ol>
                <li>
                    Intercept the OAuth request using controlledframe's onBeforeRequest
                    and block it
                </li>
                <li>
                    Send the OAuth request URL to our SSO extension using message
                    passing
                </li>
                <li>
                    SSO extension opens a regular browser tab with the OAuth request URL
                </li>
                <li>
                    Because we already have a logged in account with prior OAuth consent
                    to the selected scope (OpenID) in the browser, the OAuth request
                    immediately redirects to the specified redirect_url (given as part
                    of the initial request URL) with the authorization code as URL
                    parameter
                </li>
                <li>
                    The SSO extension intercepts that redirect using a blocking
                    onBeforeRequest
                </li>
                <li>
                    The SSO extension closes the browser tab where the OAuth request was
                    perfomed
                </li>
                <li>
                    The SSO extension sends the resulting redirect URL with
                    authorization code as URL parameter back to the IWA via message
                    passing
                </li>
                <li>
                    The IWA sets the controlledframe's src URL to the given redirect URL
                </li>
            </ol>
            <p>
                Now the OAuth playground site receives the authorization token from
                the redirect URL parameters
            </p>
            <button id="enableSsoOffloadingButton" disabled>
                Setup SSO offloading
            </button>
            <controlledframe id="ssoCf"
                src="https://developers.google.com/oauthplayground/#step1&apisSelect=openid&url=https%3A%2F%2F&content_type=application%2Fjson&http_method=GET&useDefaultOauthCred=unchecked&oauthEndpointSelect=Google&oauthAuthEndpointValue=https%3A%2F%2Faccounts.google.com%2Fo%2Foauth2%2Fv2%2Fauth&oauthTokenEndpointValue=https%3A%2F%2Foauth2.googleapis.com%2Ftoken&includeCredentials=unchecked&accessTokenType=bearer&autoRefreshToken=unchecked&accessType=offline&prompt=none&response_type=code&wrapLines=on">
            </controlledframe>
        </div>
    </div>
</body>
</html>
